# バブルチャート（議員 × 支出項目）

`members_expenses.json` を読み込み、D3.js で議員×支出項目のバブルチャートを描画します。表示モードは「全体」「議員ごと」「項目ごと」に切り替え可能で、重なりを避けつつ各グループ内は“できるだけ密に”寄せるよう最適化しています。

- 使用技術: D3.js v7（CDN）、プレーン HTML/CSS/JS
- 配布形態: ビルド不要の静的ファイル（`index.html` / `styles.css` / `main.js` / JSON）
- 動作環境: 近年のモダンブラウザ

## 起動方法（ローカル）

`fetch` で JSON を読み込むため、`file://` 直接オープンは CORS で失敗します。ローカルサーバで配信してください。

1. ターミナルで本ディレクトリへ移動
2. 簡易サーバを起動（いずれか）
   - Python 3: `python3 -m http.server 8000`
   - Node.js: `npx serve -l 8000`（未導入なら `npm i -g serve`）
3. ブラウザで `http://localhost:8000/` を開く

同階層の `members_expenses.json` を自動読み込みします。

## GitHub Pages での公開

1. リポジトリを GitHub へ push
2. Settings → Pages → `Deploy from a branch`
3. Branch: `main`（または `master`）/ `/(root)` を選択
4. 数分後に表示される URL へアクセス

## ファイル構成

- `index.html`: 画面の骨組み（ヘッダ、モード切替ボタン、ルート要素）
- `styles.css`: スタイル（sticky 凡例、レイアウトなど）
- `main.js`: 描画・レイアウト・モード切替のロジック
- `members_expenses.json`: データ（同一ディレクトリから自動読み込み）

## データ形式（JSON）

`members_expenses.json` は以下の配列です（例）。

```json
[
  {
    "id": "m01",
    "name": "田中 太郎",
    "expenses": [
      { "category": "広報", "value": 145000 },
      { "category": "研修", "value": 145000 },
      { "category": "調査", "value": 100000 },
      { "category": "交通", "value": 100000 }
    ]
  }
]
```

起動時にフラット配列へ変換して描画します：

```js
// { id, memberId, memberName, category, value }
{ id: "m01-広報", memberId: "m01", memberName: "田中 太郎", category: "広報", value: 145000 }
```

## UI と操作

- 「全体」: すべての支出を 1 つのパックレイアウトで表示
- 「議員ごと」: 議員単位にセルへ分割して表示（グループ内は最密に近く詰める）
- 「項目ごと」: 項目カテゴリ単位にセルへ分割
- ツールチップ: バブルにホバーで詳細（氏名／カテゴリ／金額）
- 凡例（sticky）: カテゴリ色とサイズ目安を `#bubble-root` の先頭に固定表示
- リサイズ追従: `ResizeObserver` で自動再レイアウト

## 実装の全体像

- データ整形: `flattenMembers()` で階層 JSON → フラット配列
- 色スケール: カテゴリ → 色（`d3.schemeTableau10`）
- 半径スケール: 値 → 半径（平方根スケール）。全体モードで得たスケール係数を共有して各モードで一貫性を維持
- 凡例: カテゴリ色＋サイズ凡例。サイズは全データの値をもとに「ジェンクス自然分類（3 クラス）」で代表値を出し、丸の大きさで提示
- レイアウト
  - 全体モード: `d3.pack()` による詰め込み（`padding` は最小限）。得られた半径からグローバル係数 `globalRadiusK` を推定
  - 議員/項目モード: 各グループを `d3.packSiblings()` で最密に近く詰め、グリッドのセル中心に平行移動。最後に軽い衝突除去を行い、境界外へのはみ出しを防止
- 衝突回避
  - 物理シミュレーションの `forceCollide`（全体/初期用）
  - グループ内は「d3.packSiblings → 局所リラクゼーション（ペア押し広げ）」の二段構え

## レイアウトと重なり制御の詳細

- パラメータ
  - `COLLIDE_PAD = 0.8`: 全体/力学系での最小クリアランス
  - `INNER_PAD = 0.35`: グループ内での最小クリアランス（見た目のごく薄い隙間）
- グループ内の手順
  1) `d3.packSiblings()` に各円の半径（`bubbleRadius(value) + INNER_PAD`）を渡し、原点付近で最密に近い配置を得る
  2) 得られた配置のバウンディングボックスから必要セルサイズを決定（推測ではなく実測値）。幅が足りないセルは自動で列数を増やし、SVG 高さを伸ばす
  3) セル中心へ並進後、ペアごとの押し広げ（局所リラクゼーション）で微小な食い込みを除去。最後にセル境界内へクランプ

この組合せにより、「重なりは発生しない」「かつ、グループ感が強い（できるだけ密）」という見た目を両立しています。

## サイズ凡例とジェンクス自然分類（やさしい解説）

凡例のサイズは、単なる固定値ではなく、データのばらつきに合わせて自動で分かりやすい代表値を選びます。そのために「ジェンクス自然分類（Jenks natural breaks）」という手法を使っています。

### ジェンクス自然分類とは？

- 目的: 数値の集合を k 個のグループに区切るとき、「同じグループの値は似ていて、違うグループの値は離れている」ように分けたい
- 直感: ヒストグラムで“山”がいくつか見えたら、その“谷”の位置に境界線を引くイメージ
- 形式: 各グループ内のばらつき（分散）をできるだけ小さく、グループ間の差をできるだけ大きくする区切り（ブレークポイント）を見つける

### どうやって求めるの？（動的計画法のイメージ）

1. まずデータを小さい順に並べます
2. 「先頭から i 個の値を j グループに分けたときの最小の“合計ばらつき”」を表にして、手前から順に埋めていきます
3. その際、どこで区切ると最小になるかも同時に記録しておきます
4. 最後に表を後ろからたどると、最適な区切り位置（ブレークポイント）が復元できます

この表埋めを「動的計画法（Dynamic Programming）」と呼びます。実装上は、分散の合計（残差平方和）を最小化するように j を 1→k へ広げながら計算します。

### 本実装での扱い

- 関数: `jenksBreaks(values, k)`（`main.js`）
- 入力: 値配列 `values` とクラス数 `k`（本ツールでは k=3 を凡例表示に使用）
- 出力: `[min, b1, b2, max]` のようなブレーク配列
- 用途: `[b1, b2, max]` を代表値として丸のサイズ見本を描画
- フォールバック: データ数が少ない等で安定しない場合は分位点（1/3, 2/3）で代用

### ジェンクスの利点と注意

- 利点: “自然な区切れ目”を自動で捉えやすく、極端値に引きずられにくい
- 注意: k の選び方で印象が変わる。ここでは凡例の視認性を優先して 3 クラスに固定

## スタイル / 凡例の配置

- 凡例は HTML で描画し、`#bubble-root` の先頭に `position: sticky; top: 0;` で固定
- カテゴリ色は `d3.scaleOrdinal` × `d3.schemeTableau10`（カテゴリ数が多い場合は自動で繰り返し）
- サイズ凡例はジェンクスの代表値を `bubbleRadius` に通し、直径を CSS の `width/height` で示す

## 調整パラメータ（どこを変えれば見た目がどう変わるか）

- `main.js`
  - `COLLIDE_PAD`（既定 0.8）: 全体/力学系の最小すき間。小さくすると密、重なるリスク増
  - `INNER_PAD`（既定 0.35）: グループ内の最小すき間。小さくするとさらに“ぎゅっ”と寄る
  - `relaxNoOverlap(..., iter)` の反復回数: 大きくすると重なり解消は堅牢に、コストは増
  - 半径レンジ: `d3.scaleSqrt().range([6, 28])` を調整

## よくあるハマりどころ

- `file://` 直開きは不可。必ず HTTP で配信
- CDN（`https://cdn.jsdelivr.net/npm/d3@7`）にアクセスできない環境では表示不可。必要に応じて D3 を同梱

## ライセンス / クレジット

- D3.js (Mike Bostock 他)
- カラースキーム: Tableau 10（D3 内蔵）
- ライセンス: 必要に応じて追記してください

---

要望（例: 絞り込み・検索、PNG エクスポート、凡例の表示値固定化、色分けルール変更 等）があれば Issue まで。ジェンクスの k を変更したい場合は `drawLegend()` 付近の呼び出しとラベルの出し方を調整してください。
